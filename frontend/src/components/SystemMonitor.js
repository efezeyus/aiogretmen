import React, { useState, useEffect } from 'react';
import api from '../services/api';
import './SystemMonitor.css';

const SystemMonitor = () => {
  const [systemHealth, setSystemHealth] = useState(null);
  const [aiModels, setAiModels] = useState(null);
  const [learningStats, setLearningStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchSystemData();
    // Her 30 saniyede bir g√ºncelle
    const interval = setInterval(fetchSystemData, 30000);
    return () => clearInterval(interval);
  }, []);

  const fetchSystemData = async () => {
    try {
      setLoading(true);
      
      // Sistem saƒülƒ±k durumu
      const healthResponse = await api.get('/system/health');
      setSystemHealth(healthResponse.data);
      
      // AI modelleri
      const modelsResponse = await api.get('/system/ai-models');
      setAiModels(modelsResponse.data);
      
      // √ñƒürenme istatistikleri
      const statsResponse = await api.get('/system/learning-stats');
      setLearningStats(statsResponse.data);
      
      setError(null);
    } catch (err) {
      console.error('System data fetch error:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const triggerLearningCycle = async () => {
    try {
      const response = await api.post('/system/trigger-learning');
      if (response.data.success) {
        alert('√ñƒürenme d√∂ng√ºs√º ba≈üarƒ±yla tetiklendi!');
        fetchSystemData();
      }
    } catch (err) {
      alert('Hata: ' + err.message);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'active':
      case 'healthy':
        return '#48bb78';
      case 'inactive':
      case 'degraded':
        return '#f59e0b';
      case 'error':
        return '#f56565';
      default:
        return '#718096';
    }
  };

  const getStatusIcon = (status) => {
    switch (status) {
      case 'active':
      case 'healthy':
        return '‚úÖ';
      case 'inactive':
        return '‚ö†Ô∏è';
      case 'error':
        return '‚ùå';
      case 'degraded':
        return '‚ö°';
      default:
        return '‚ùì';
    }
  };

  if (loading) {
    return (
      <div className="system-monitor loading">
        <div className="loading-spinner">‚öôÔ∏è Sistem bilgileri y√ºkleniyor...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="system-monitor error">
        <div className="error-message">
          <span className="error-icon">‚ö†Ô∏è</span>
          <p>Sistem bilgileri y√ºklenemedi: {error}</p>
          <button onClick={fetchSystemData}>Tekrar Dene</button>
        </div>
      </div>
    );
  }

  return (
    <div className="system-monitor">
      <div className="monitor-header">
        <h1>üñ•Ô∏è Sistem Durumu Monit√∂r√º</h1>
        <div className="header-actions">
          <button className="refresh-btn" onClick={fetchSystemData}>
            üîÑ Yenile
          </button>
          <span className="last-update">
            Son g√ºncelleme: {new Date().toLocaleTimeString('tr-TR')}
          </span>
        </div>
      </div>

      {/* Genel Sistem Durumu */}
      {systemHealth && (
        <div className="monitor-section">
          <h2>Genel Durum</h2>
          <div className="overall-status">
            <div 
              className="status-indicator"
              style={{ backgroundColor: getStatusColor(systemHealth.status) }}
            >
              {getStatusIcon(systemHealth.status)}
            </div>
            <div className="status-info">
              <h3>{systemHealth.status.toUpperCase()}</h3>
              <p>Versiyon: {systemHealth.version}</p>
              <p>Zaman: {new Date(systemHealth.timestamp).toLocaleString('tr-TR')}</p>
            </div>
          </div>

          {/* Servis Durumlarƒ± */}
          <div className="services-grid">
            {Object.entries(systemHealth.services).map(([service, info]) => (
              <div key={service} className="service-card">
                <div className="service-header">
                  <span className="service-icon">
                    {getStatusIcon(info.status)}
                  </span>
                  <h4>{service.toUpperCase()}</h4>
                </div>
                <div className="service-status">
                  <span 
                    className="status-badge"
                    style={{ 
                      backgroundColor: getStatusColor(info.status),
                      color: 'white'
                    }}
                  >
                    {info.status}
                  </span>
                </div>
                {info.reason && (
                  <p className="service-reason">{info.reason}</p>
                )}
                {info.error && (
                  <p className="service-error">Hata: {info.error}</p>
                )}
                {info.model && (
                  <p className="service-detail">Model: {info.model}</p>
                )}
                {info.database && (
                  <p className="service-detail">Database: {info.database}</p>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* AI Modelleri */}
      {aiModels && (
        <div className="monitor-section">
          <h2>ü§ñ AI Modelleri</h2>
          <div className="ai-models-info">
            <div className="current-model">
              <h3>Aktif Model</h3>
              <p className="model-name">{aiModels.current_model}</p>
              <p className="model-provider">Provider: {aiModels.current_provider}</p>
            </div>
            
            <div className="available-models">
              <h3>Mevcut Modeller</h3>
              {Object.entries(aiModels.available_models).map(([provider, info]) => (
                <div key={provider} className="model-provider">
                  <h4>{provider.toUpperCase()}</h4>
                  <span className={`status ${info.status}`}>
                    {info.status === 'active' ? 'üü¢' : 'üî¥'} {info.status}
                  </span>
                  {info.models && (
                    <ul>
                      {info.models.map(model => (
                        <li key={model}>{model}</li>
                      ))}
                    </ul>
                  )}
                  {info.model && <p>Model: {info.model}</p>}
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* √ñƒürenme ƒ∞statistikleri */}
      {learningStats && (
        <div className="monitor-section">
          <h2>üìä √ñƒürenme ƒ∞statistikleri</h2>
          
          {learningStats.performance && (
            <div className="performance-stats">
              <h3>Son 7 G√ºnl√ºk Performans</h3>
              <div className="stats-grid">
                <div className="stat-item">
                  <span className="stat-label">Toplam Etkile≈üim</span>
                  <span className="stat-value">
                    {learningStats.performance.overall?.total_interactions || 0}
                  </span>
                </div>
                <div className="stat-item">
                  <span className="stat-label">Pozitif Geri Bildirim</span>
                  <span className="stat-value">
                    {Math.round((learningStats.performance.overall?.avg_positive_feedback || 0) * 100)}%
                  </span>
                </div>
                <div className="stat-item">
                  <span className="stat-label">Ortalama G√ºven</span>
                  <span className="stat-value">
                    {Math.round((learningStats.performance.overall?.avg_confidence || 0) * 100)}%
                  </span>
                </div>
                <div className="stat-item">
                  <span className="stat-label">Yanƒ±t S√ºresi</span>
                  <span className="stat-value">
                    {(learningStats.performance.overall?.avg_response_time || 0).toFixed(2)}s
                  </span>
                </div>
              </div>

              {/* ƒ∞yile≈ütirme Alanlarƒ± */}
              {learningStats.performance.overall?.improvement_areas?.length > 0 && (
                <div className="improvement-areas">
                  <h4>‚ö° ƒ∞yile≈ütirme Alanlarƒ±</h4>
                  <ul>
                    {learningStats.performance.overall.improvement_areas.map((area, idx) => (
                      <li key={idx}>
                        <strong>{area.subject} - {area.grade}. Sƒ±nƒ±f:</strong>
                        <span> Memnuniyet %{Math.round(area.current_satisfaction * 100)}</span>
                        <p className="recommendation">{area.recommendation}</p>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}

          {/* Son ƒ∞yile≈ütirme D√∂ng√ºs√º */}
          {learningStats.last_improvement_cycle && (
            <div className="last-cycle">
              <h3>Son ƒ∞yile≈ütirme D√∂ng√ºs√º</h3>
              <p>Tarih: {new Date(learningStats.last_improvement_cycle.timestamp).toLocaleString('tr-TR')}</p>
              <p>Olu≈üturulan Eƒüitim Verisi: {learningStats.last_improvement_cycle.training_data_generated}</p>
              
              {learningStats.last_improvement_cycle.action_items?.length > 0 && (
                <div className="action-items">
                  <h4>Eylem √ñƒüeleri</h4>
                  {learningStats.last_improvement_cycle.action_items.map((item, idx) => (
                    <div key={idx} className={`action-item priority-${item.priority}`}>
                      <span className="priority">{item.priority.toUpperCase()}</span>
                      <strong>{item.action}</strong>
                      <p>{item.details}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Manuel Tetikleme */}
          <div className="manual-trigger">
            <button 
              className="trigger-btn"
              onClick={triggerLearningCycle}
            >
              üîÑ √ñƒürenme D√∂ng√ºs√ºn√º Manuel Tetikle
            </button>
            <p className="trigger-info">
              Otomatik d√∂ng√º her {learningStats.learning_parameters?.learning_interval_days || 7} g√ºnde bir √ßalƒ±≈üƒ±r.
            </p>
          </div>
        </div>
      )}

      {/* Sistem √ñzellikleri */}
      <div className="monitor-section">
        <h2>‚öôÔ∏è Sistem √ñzellikleri</h2>
        <div className="features-grid">
          <div className="feature-item active">
            <span className="feature-icon">üß†</span>
            <span className="feature-name">Auto Learning</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üìä</span>
            <span className="feature-name">Adaptive Learning</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üîç</span>
            <span className="feature-name">RAG (Retrieval Augmented Generation)</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üé§</span>
            <span className="feature-name">Voice Integration</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üëÅÔ∏è</span>
            <span className="feature-name">Computer Vision</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üèÜ</span>
            <span className="feature-name">Gamification</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üîó</span>
            <span className="feature-name">Blockchain Certificates</span>
          </div>
          <div className="feature-item active">
            <span className="feature-icon">üòä</span>
            <span className="feature-name">Emotion Detection</span>
          </div>
        </div>
      </div>

      {/* A√ßƒ±klama */}
      <div className="monitor-footer">
        <p>
          Bu monit√∂r, Yapay Zeka √ñƒüretmen sisteminin t√ºm bile≈üenlerinin durumunu g√∂sterir.
          Sistem otomatik olarak kendini geli≈ütirir ve √∂ƒürenci etkile≈üimlerinden √∂ƒürenir.
        </p>
        <p>
          <strong>DeepSeek AI</strong> ana dil modeli olarak kullanƒ±lmaktadƒ±r.
          Sistem, √∂ƒürenci geri bildirimlerini analiz ederek s√ºrekli iyile≈ütirilmektedir.
        </p>
      </div>
    </div>
  );
};

export default SystemMonitor;
